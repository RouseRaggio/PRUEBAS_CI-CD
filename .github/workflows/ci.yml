name: Django CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  lint:
    name: Lint (flake8)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt



  test:
    name: Tests (pytest)
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_NAME: test_db
      DB_USER: test_user
      DB_PASSWORD: test_password
      DB_HOST: localhost
      DB_PORT: 5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run migrations
        run: |
          python manage.py migrate

      - name: Run tests
        run: |
          pytest


  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t proyect_ci:latest .

  deploy:
      name: Deploy to Server (Docker)
      runs-on: ubuntu-latest
      needs: build

      steps:
        - uses: actions/checkout@v4

        - name: Deploy via SSH
          uses: appleboy/ssh-action@v1.0.0
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.SERVER_SSH_KEY }}
            script: |
              cd /var/www/mi_proyecto

              echo " Actualizando c√≥digo..."
              git pull origin main

              echo " Construyendo y levantando contenedores..."
              docker compose down
              docker compose build
              docker compose up -d

              echo " Ejecutando migraciones..."
              docker compose exec app php artisan migrate --force

              echo " Limpiando cache..."
              docker compose exec app php artisan config:clear
              docker compose exec app php artisan cache:clear
              docker compose exec app php artisan route:clear
              docker compose exec app php artisan view:clear

              echo " ------------------Deploy completado------------------- "